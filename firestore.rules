rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow users to read/write rides they're involved in
    match /rides/{rideId} {
      allow read, write: if request.auth != null && 
        (resource == null || 
         resource.data.riderId == request.auth.uid || 
         resource.data.driverId == request.auth.uid);
    }
    
    // Allow users to read/write their own wallet
    match /wallets/{walletId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Allow users to read/write their own feedback
    match /feedback/{feedbackId} {
      allow read, write: if request.auth != null && 
        (resource == null || 
         resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
    }
    
    // Allow users to read/write their own ratings
    match /user_ratings/{ratingId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Allow users to read/write their own payments
    match /payments/{paymentId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Allow users to read/write their own saved payment methods
    match /saved_payment_methods/{methodId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Allow users to read/write their own carpool rides
    match /carpool_rides/{carpoolId} {
      allow read, write: if request.auth != null && 
        (resource == null || 
         resource.data.driverId == request.auth.uid || 
         resource.data.riders[request.auth.uid] != null);
    }
    
    // Allow users to read/write their own carpool riders
    match /carpool_riders/{riderId} {
      allow read, write: if request.auth != null && 
        (resource == null || 
         resource.data.driverId == request.auth.uid || 
         resource.data.riderId == request.auth.uid);
    }
    
    // Allow users to read/write their own carpool stops
    match /carpool_stops/{stopId} {
      allow read, write: if request.auth != null && 
        (resource == null || 
         resource.data.carpoolId in get(/databases/$(database)/documents/carpool_rides/$(resource.data.carpoolId)).data.riders[request.auth.uid]);
    }
    
    // Allow users to read/write their own notification settings
    match /notification_settings/{settingId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Allow users to read/write their own system configurations
    match /system_config/{configId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
